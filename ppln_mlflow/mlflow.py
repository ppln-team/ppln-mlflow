import mlflow

from ppln.hooks import BaseLoggerHook
from ppln.hooks.logger.utils import get_lr
from ppln.hooks.priority import Priority
from ppln.hooks.registry import HOOKS
from ppln.utils.misc import master_only


@HOOKS.register_module
class MlFlowLoggerHook(BaseLoggerHook):
    def __init__(self):
        super().__init__()

    @property
    def priority(self):
        return Priority.VERY_LOW

    @master_only
    def log_lr(self, lr_dict):
        for optimizer_name, lrs in lr_dict.items():
            if len(lrs) == 1:
                mlflow.log_metric(f"{optimizer_name}_lr", lrs[0])
            else:
                for i, lr in enumerate(lrs):
                    mlflow.log_metric(f"{optimizer_name}_{i}_lr", lr)

    @master_only
    def log(self, runner):
        for value in runner.log_buffer.output:
            if value in ["time", "data_time"]:
                continue
            tag = f"{runner.mode}_{value}"
            record = runner.log_buffer.output[value]
            if isinstance(record, str):
                pass
            else:
                mlflow.log_metric(tag, record, runner.epoch)

            if runner.mode == "train":
                lr_dict = get_lr(runner.optimizers)
                self.log_lr(lr_dict)

    def after_epoch(self, runner):
        self.log(runner)
